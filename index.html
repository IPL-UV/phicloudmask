
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="phicloudmask is a Python library for efficient cloud masking in satellite imagery using deep learning models.">
      
      
        <meta name="author" content="IPL-UV Project">
      
      
        <link rel="canonical" href="https://ipl-uv.github.io/phicloudmask/index.html">
      
      <link rel="icon" href="https://huggingface.co/datasets/JulioContrerasH/DataMLSTAC/resolve/main/logo_phi.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.2.16">
    
    
      
        <title>Index - phicloudmask</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.1c3799f8.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="docs/style/style.css">
    
    <script>__md_scope=new URL(".",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="black">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="phicloudmask" class="md-header__button md-logo" aria-label="phicloudmask" data-md-component="logo">
      
  <img src="https://huggingface.co/datasets/JulioContrerasH/DataMLSTAC/resolve/main/logo_phi.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            phicloudmask
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Index
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="black"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="#201357" data-md-color-accent="white"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/IPL-UV/phicloudmask" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    phicloudmask
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="index.html" class="md-tabs__link md-tabs__link--active">
        Home
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="phicloudmask" class="md-nav__button md-logo" aria-label="phicloudmask" data-md-component="logo">
      
  <img src="https://huggingface.co/datasets/JulioContrerasH/DataMLSTAC/resolve/main/logo_phi.png" alt="logo">

    </a>
    phicloudmask
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/IPL-UV/phicloudmask" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    phicloudmask
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index md-nav__link--active">
          <a href="index.html">Home</a>
          
            <label for="__nav_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="CONTRIBUTING.html" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="CHANGELOG.html" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="CODE_OF_CONDUCT.html" class="md-nav__link">
        Code of conduct
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    Overview 📊
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background 🛰️
  </a>
  
    <nav class="md-nav" aria-label="Background 🛰️">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#relevant-links" class="md-nav__link">
    Relevant links 🔗
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation ⚙️
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage" class="md-nav__link">
    Usage 🚀
  </a>
  
    <nav class="md-nav" aria-label="Usage 🚀">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#load-data-and-weights" class="md-nav__link">
    Load data and weights 📥
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generate-cloud-masks" class="md-nav__link">
    Generate cloud masks ☁️
  </a>
  
    <nav class="md-nav" aria-label="Generate cloud masks ☁️">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-all-spectral-bands" class="md-nav__link">
    Using all spectral bands 🌈
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-rgb-bands-only" class="md-nav__link">
    Using RGB bands only 🎨
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#visualize-the-results" class="md-nav__link">
    Visualize the results 📊
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#additional-information" class="md-nav__link">
    Additional information ✔️
  </a>
  
    <nav class="md-nav" aria-label="Additional information ✔️">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#understanding-the-model" class="md-nav__link">
    Understanding the model 🧠
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/IPL-UV/phicloudmask/edit/master/docs/README.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="_1"></h1>
<p align="center">
  <img src="https://huggingface.co/datasets/JulioContrerasH/DataMLSTAC/resolve/main/banner_phicloudmask.png" width="39%">
</p>

<p align="center">
    <em>A Python package for efficient cloud masking in satellite imagery using deep learning models</em> 🚀
</p>

<p align="center">
<a href='https://pypi.python.org/pypi/satalign'>
    <img src='https://img.shields.io/pypi/v/satalign.svg' alt='PyPI' />
</a>
<a href="https://opensource.org/licenses/MIT" target="_blank">
    <img src="https://img.shields.io/badge/License-MIT-blue.svg" alt="License">
</a>
<a href="https://github.com/psf/black" target="_blank">
    <img src="https://img.shields.io/badge/code%20style-black-000000.svg" alt="Black">
</a>
<a href="https://pycqa.github.io/isort/" target="_blank">
    <img src="https://img.shields.io/badge/%20imports-isort-%231674b1?style=flat&labelColor=ef8336" alt="isort">
</a>
</p>

<hr />
<p><strong>GitHub</strong>: <a href="https://github.com/IPL-UV/satalign">https://github.com/IPL-UV/satalign</a> 🌐</p>
<p><strong>PyPI</strong>: <a href="https://pypi.org/project/satalign/">https://pypi.org/project/satalign/</a> 🛠️</p>
<hr />
<h2 id="overview"><strong>Overview</strong> 📊</h2>
<p><code>phicloudmask</code> is a Python package designed to generate cloud masks from Sentinel-2 satellite imagery using a deep learning model. The model can classify different semantic categories such as land, water, snow, various types of clouds, shadows, and areas with no data. This project is inspired by and builds upon the <code>SEnSeIv2</code> model developed by Francis et al.</p>
<h2 id="background"><strong>Background</strong> 🛰️</h2>
<p>The original code by Francis was complex and hard to understand, so this project aims to provide a more Pythonic and user-friendly implementation. The goal is to offer a straightforward way to apply cloud masking to Sentinel-2 imagery and to provide a foundation for building custom models.</p>
<h3 id="relevant-links"><strong>Relevant links</strong> 🔗</h3>
<ul>
<li>📄 <strong>Research Paper</strong>: <a href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=10505181">SEnSeIv2: Improved Cloud Masking for Sentinel-2 Imagery</a></li>
<li>🗃️ <strong>Original Repository</strong>: <a href="https://github.com/aliFrancis/SEnSeIv2">GitHub - SEnSeIv2</a></li>
<li>🤗 <strong>Model on Hugging Face</strong>: <a href="https://huggingface.co/aliFrancis/SEnSeIv2">Hugging Face - SEnSeIv2</a></li>
</ul>
<h2 id="installation"><strong>Installation</strong> ⚙️</h2>
<p>To install the <code>phicloudmask</code> package, run the following command:</p>
<div class="highlight"><pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>phicloudmask
</code></pre></div>
<h2 id="usage"><strong>Usage</strong> 🚀</h2>
<p>The following sections provide detailed instructions on how to use the <code>phicloudmask</code> model for cloud masking.</p>
<h3 id="load-data-and-weights"><strong>Load data and weights</strong> 📥</h3>
<p>Before you begin, ensure that you have the necessary weights and data files in the weights/ directory:</p>
<ul>
<li><code>spectral_embedding.pt</code>: Weights for the embedding model.</li>
<li><code>cloudmask_weights.pt</code>: Weights for the cloud mask model.</li>
<li><code>demo.pkl</code>: Sample data file containing Sentinel-2 imagery and cloud masks.</li>
</ul>
<p>Load the data and weights into your Python environment:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">phicloudmask</span> <span class="kn">import</span> <span class="n">CloudMask</span>
<span class="kn">from</span> <span class="nn">phicloudmask.constant</span> <span class="kn">import</span> <span class="n">SENTINEL2_DESCRIPTORS</span>

<span class="c1"># Define the semantic categories mapping</span>
<span class="n">cloudsen12_style</span> <span class="o">=</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Merged into category 0 (land, water, snow, no_data)</span>
    <span class="mi">4</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                   <span class="c1"># Thick cloud -&gt; category 1</span>
    <span class="mi">3</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>                   <span class="c1"># Thin cloud -&gt; category 2</span>
    <span class="mi">5</span><span class="p">:</span> <span class="mi">3</span>                    <span class="c1"># Shadow -&gt; category 3</span>
<span class="p">}</span>
<span class="n">map_values</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">cloudsen12_style</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

<span class="c1"># Load the weights</span>
<span class="n">weights_folder</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;weights/&quot;</span><span class="p">)</span>
<span class="n">embedding_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_folder</span> <span class="o">/</span> <span class="s2">&quot;spectral_embedding.pt&quot;</span><span class="p">)</span>
<span class="n">cloudmask_weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">weights_folder</span> <span class="o">/</span> <span class="s2">&quot;cloudmask_weights.pt&quot;</span><span class="p">)</span>

<span class="c1"># Load a sample image</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">weights_folder</span> <span class="o">/</span> <span class="s2">&quot;demo.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">dict_demo</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">array_demo</span> <span class="o">=</span> <span class="n">dict_demo</span><span class="p">[</span><span class="s2">&quot;s2&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">]</span>  <span class="c1"># S2 L1C image</span>
    <span class="n">mask_demo</span> <span class="o">=</span> <span class="n">dict_demo</span><span class="p">[</span><span class="s2">&quot;cloud_mask&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">512</span><span class="p">]</span>  <span class="c1"># Original mask</span>
</code></pre></div>
<h3 id="generate-cloud-masks"><strong>Generate cloud masks</strong> ☁️</h3>
<h4 id="using-all-spectral-bands"><strong>Using all spectral bands</strong> 🌈</h4>
<p>To generate cloud masks using all Sentinel-2 spectral bands:</p>
<p><strong>1. Initialize the model:</strong></p>
<p><div class="highlight"><pre><span></span><code><span class="c1"># Initialize the cloud mask model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CloudMask</span><span class="p">(</span><span class="n">descriptor</span><span class="o">=</span><span class="n">SENTINEL2_DESCRIPTORS</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">embedding_weights</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">cloud_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">cloudmask_weights</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
<strong>2. Generate cloud mask:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">array_demo</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">cloud_probs_all</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">cloud_mask_all</span> <span class="o">=</span> <span class="n">cloud_probs_all</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">cloud_4class_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_values</span><span class="p">)(</span><span class="n">cloud_mask_all</span><span class="p">)</span>
</code></pre></div>
<h4 id="using-rgb-bands-only"><strong>Using RGB bands only</strong> 🎨</h4>
<p>To generate cloud masks using only the RGB bands:</p>
<p><strong>1. Define RGB bands descriptors:</strong></p>
<p><div class="highlight"><pre><span></span><code><span class="n">RGB_DESCRIPTORS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;band_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TOA Reflectance&quot;</span><span class="p">,</span> <span class="s2">&quot;min_wavelength&quot;</span><span class="p">:</span> <span class="mf">645.5</span><span class="p">,</span> <span class="s2">&quot;max_wavelength&quot;</span><span class="p">:</span> <span class="mf">684.5</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;band_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TOA Reflectance&quot;</span><span class="p">,</span> <span class="s2">&quot;min_wavelength&quot;</span><span class="p">:</span> <span class="mf">537.5</span><span class="p">,</span> <span class="s2">&quot;max_wavelength&quot;</span><span class="p">:</span> <span class="mf">582.5</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;band_type&quot;</span><span class="p">:</span> <span class="s2">&quot;TOA Reflectance&quot;</span><span class="p">,</span> <span class="s2">&quot;min_wavelength&quot;</span><span class="p">:</span> <span class="mf">446.0</span><span class="p">,</span> <span class="s2">&quot;max_wavelength&quot;</span><span class="p">:</span> <span class="mf">542.0</span><span class="p">},</span>
<span class="p">]</span>
</code></pre></div>
<strong>2. Reinitialize the model for RGB:</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">CloudMask</span><span class="p">(</span><span class="n">descriptor</span><span class="o">=</span><span class="n">RGB_DESCRIPTORS</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">embedding_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">embedding_weights</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">cloud_model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">cloudmask_weights</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>
<p><strong>3. Generate cloud mask for RGB bands:</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">array_demo</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]][</span><span class="kc">None</span><span class="p">])</span><span class="o">.</span><span class="n">float</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cuda&quot;</span><span class="p">)</span>
    <span class="n">cloud_probs_rgb</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">cloud_mask_rgb</span> <span class="o">=</span> <span class="n">cloud_probs_rgb</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
    <span class="n">cloud_4class_rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">map_values</span><span class="p">)(</span><span class="n">cloud_mask_rgb</span><span class="p">)</span>
</code></pre></div>
<h3 id="visualize-the-results"><strong>Visualize the results</strong> 📊</h3>
<p>To visualize the original RGB image, the ground truth mask, and the predicted cloud masks:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RGB Image&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mask_demo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Mask - SEnSeIv2&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cloud_4class_all</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;All Bands Mask - phiCloudMask&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cloud_4class_rgb</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;RGB Bands Mask - phiCloudMask&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<p align="center">
  <img src="https://huggingface.co/datasets/JulioContrerasH/DataMLSTAC/resolve/main/phi1.png" width="100%">
</p>

<h2 id="additional-information"><strong>Additional information</strong> ✔️</h2>
<h3 id="understanding-the-model"><strong>Understanding the model</strong> 🧠</h3>
<p>The <code>phiCloudMask</code> model leverages a pre-trained neural network architecture to predict cloud masks. It uses two main sets of weights:</p>
<ul>
<li><strong>Embedding weights</strong>: Used to convert the spectral data into a meaningful representation for the model.</li>
<li><strong>Cloud mask weights</strong>: Used for the final classification of each pixel into the predefined categories.</li>
</ul>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
      
        
        <a href="CONTRIBUTING.html" class="md-footer__link md-footer__link--next" aria-label="Next: Contributing" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Contributing
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": ".", "features": ["navigation.instant", "navigation.tabs", "navigation.top", "navigation.expand", "navigation.indexes", "header.autohide"], "search": "assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.3a4b43e5.min.js"></script>
      
        <script src="docs/js/copybutton.js"></script>
      
    
  </body>
</html>